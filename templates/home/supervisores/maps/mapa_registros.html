{% extends "central_user.html" %}
{% load static %}

{% block title %}Mapa de Registros - {{ vigencia_plan.plan.nombre }}{% endblock %}

{% block content %}
<div class="container py-4">
    <h1 class="h4 mb-4 text-primary"><i class="fas fa-map-marked-alt me-2"></i>Mapa de Registros de Entrada</h1>
    <a href="{% url 'supervisor_home_asistencia' vigencia_plan.empresa.id vigencia_plan.id %}" class="btn btn-outline-secondary mb-4">
        <i class="fas fa-arrow-left me-2"></i>Volver
    </a>
    <div id="map" style="height: 500px; width: 100%; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);"></div>
</div>

<script>
    // Convertir la cadena JSON en un arreglo JavaScript
    var registrosData = JSON.parse('{{ registros_data|escapejs }}');

    // Depuración: Verificar que registrosData es un arreglo
    console.log('registrosData:', registrosData);
    console.log('Es un arreglo:', Array.isArray(registrosData));

    window.initMap = function() {
        var map = new google.maps.Map(document.getElementById('map'), {
            zoom: 10,
            center: {lat: -33.4489, lng: -70.6693},
            mapId: '{{ google_maps_map_id }}'
        });

        if (registrosData.length > 0) {
            var bounds = new google.maps.LatLngBounds();
            registrosData.forEach(function(registro) {
                var position = {lat: registro.lat, lng: registro.lng};
                bounds.extend(position);
                new google.maps.marker.AdvancedMarkerElement({
                    map: map,
                    position: position,
                    title: registro.title
                });
            });
            map.fitBounds(bounds);
        }
    };

    // Cargar el script de Google Maps de forma asíncrona con loading=async y libraries=marker
    var script = document.createElement('script');
    script.src = 'https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}&callback=initMap&loading=async&libraries=marker';
    script.async = true;
    script.defer = true;
    document.head.appendChild(script);
</script>
{% endblock %}